#!/usr/bin/env node
'use strict';var O=require('fs'),v=require('path'),q=require('fast-glob'),commander=require('commander'),E=require('js-yaml');function _interopDefault(e){return e&&e.__esModule?e:{default:e}}var O__default=/*#__PURE__*/_interopDefault(O);var v__default=/*#__PURE__*/_interopDefault(v);var q__default=/*#__PURE__*/_interopDefault(q);var E__default=/*#__PURE__*/_interopDefault(E);function N(t){return !!t&&typeof t=="object"&&!Array.isArray(t)}var x=/\$\{([A-Z0-9_]+)\}/g;function l(t){if(typeof t=="string")return t.replace(x,(n,e)=>process.env[e]??"");if(Array.isArray(t))return t.map(l);if(N(t)){let n={};for(let[e,i]of Object.entries(t))n[e]=l(i);return n}return t}function a(t){throw new Error(t)}function h(t){return !!t&&typeof t=="object"&&!Array.isArray(t)}function A(t){let n=O__default.default.readFileSync(t,"utf8");if(t.endsWith(".yml")||t.endsWith(".yaml"))return E__default.default.load(n);if(t.endsWith(".json"))return JSON.parse(n);a(`Unsupported file type: ${t}`);}function j(t){let n=v__default.default.resolve(process.cwd(),t);O__default.default.existsSync(n)||a(`Suite file not found: ${n}`);let e=A(n);h(e)||a("Suite file must be an object."),e.version!==1&&a(`Unsupported version: ${String(e.version)} (expected 1)`),(typeof e.suite!="string"||!e.suite.trim())&&a("suite must be a string."),(!Array.isArray(e.contracts)||e.contracts.length===0)&&a("contracts must be a non-empty array.");let i=e.contracts.map((r,f)=>{h(r)||a(`contracts[${f}] must be an object.`),(typeof r.name!="string"||!r.name.trim())&&a(`contracts[${f}].name must string.`),(!Array.isArray(r.scenarios)||r.scenarios.length===0)&&a(`contracts[${f}].scenarios must be non-empty array.`);let d=r.scenarios.map((o,p)=>{h(o)||a(`contracts[${f}].scenarios[${p}] must be an object.`),(typeof o.id!="string"||!o.id.trim())&&a("scenario id required."),h(o.http)||a(`Scenario ${o.id}: http must be object.`);let u=String(o.http.method||"").toUpperCase(),c=String(o.http.path||"");u||a(`Scenario ${o.id}: http.method is required.`),c.startsWith("/")||a(`Scenario ${o.id}: http.path must start with "/".`);let s={method:u,path:String(l(c)),headers:h(o.http.headers)?l(o.http.headers):void 0,query:h(o.http.query)?l(o.http.query):void 0,body:l(o.http.body)},y=h(o.expect)?{status:typeof o.expect.status=="number"?o.expect.status:void 0,json:"json"in o.expect?l(o.expect.json):void 0,bodyContains:typeof o.expect.bodyContains=="string"?String(l(o.expect.bodyContains)):void 0}:void 0;return {id:o.id,http:s,expect:y}}),g=new Set;for(let o of d)g.has(o.id)&&a(`Duplicate scenario id in contract "${r.name}": ${o.id}`),g.add(o.id);return {name:r.name,scenarios:d}});return {version:1,suite:e.suite,contracts:i}}function k(t){return !!t&&typeof t=="object"&&!Array.isArray(t)}function $(t,n){if(n===null||typeof n!="object")return Object.is(t,n);if(Array.isArray(n)){if(!Array.isArray(t)||n.length>t.length)return  false;for(let e=0;e<n.length;e++)if(!$(t[e],n[e]))return  false;return  true}if(k(n)){if(!k(t))return  false;for(let e of Object.keys(n))if(!(e in t)||!$(t[e],n[e]))return  false;return  true}return  false}function C(t,n){let e=t.replace(/\/+$/,""),i=n.startsWith("/")?n:`/${n}`;return `${e}${i}`}function U(t,n){if(!n)return t;let e=new URL(t);for(let[i,r]of Object.entries(n))e.searchParams.set(i,String(r));return e.toString()}async function J(t,n,e){let i=new AbortController,r=setTimeout(()=>i.abort(),e);try{return await fetch(t,{...n,signal:i.signal})}finally{clearTimeout(r);}}async function R(t,n){let e=n.http.method.toUpperCase(),i=U(C(t,n.http.path),n.http.query),r=[],f={...n.http.headers||{}},d;n.http.body!==void 0&&n.http.body!==null&&(typeof n.http.body=="string"?d=n.http.body:(d=JSON.stringify(n.http.body),f["content-type"]||(f["content-type"]="application/json")));let g=Number(process.env.STONEY_TIMEOUT_MS||15e3),o=Number(process.env.STONEY_RETRIES||2),p;for(let u=0;u<=o;u++)try{let c=await J(i,{method:e,headers:f,body:d},g),s=c.status,y=await c.text(),w;if((c.headers.get("content-type")||"").includes("application/json"))try{w=JSON.parse(y);}catch{r.push("Response advertised JSON but failed to parse JSON.");}let m=n.expect||{},b=!0;return typeof m.status=="number"&&s!==m.status&&(b=!1,r.push(`Expected status ${m.status} but got ${s}.`)),typeof m.bodyContains=="string"&&!y.includes(m.bodyContains)&&(b=!1,r.push(`Expected body to contain: "${m.bodyContains}"`)),m.json!==void 0&&(w===void 0?(b=!1,r.push("Expected JSON subset match, but response was not JSON.")):$(w,m.json)||(b=!1,r.push("Expected JSON subset did not match response JSON."))),{id:n.id,ok:b,method:e,url:i,status:s,notes:r}}catch(c){if(p=c,u<o){let s=500*(u+1);await new Promise(y=>setTimeout(y,s));continue}}return {id:n.id,ok:false,method:e,url:i,notes:[`Network/timeout error: ${p?.message||String(p)}`]}}var S=new commander.Command;S.name("stoney").description("Stoney \u2014 run HTTP contracts in CI.").version("0.0.1");S.command("hello").action(()=>console.log("\u{1FAA8} Stoney is alive."));S.command("parse").argument("<file>","Suite file (.yml/.yaml or .json)").option("--pretty","Pretty-print JSON").action((t,n)=>{let e=j(t);console.log(n.pretty?JSON.stringify(e,null,2):JSON.stringify(e));});S.command("run").requiredOption("--suite <glob>","Suite file path or glob (e.g. contracts/*.yml)").option("--base-url <url>","Base URL (defaults to STONEY_BASE_URL env var)").option("--report <path>","JSON report output path","stoney-report.json").option("--only-contract <name>","Run only one contract by name").option("--only-scenario <id>","Run only one scenario id").option("--fail-fast","Stop on first failure",false).action(async t=>{let n=t.baseUrl||process.env.STONEY_BASE_URL;n||(console.error("Missing base URL. Provide --base-url or set STONEY_BASE_URL."),process.exit(2));let e=await q__default.default(t.suite);e.length||(console.error(`No suite files matched: ${t.suite}`),process.exit(2));let i=0,r=0,f=[];console.log(`
\u{1FAA8} Stoney run`),console.log(`Base URL: ${n}`),console.log(`Suites: ${e.join(", ")}
`);for(let o of e){let p=j(o);for(let u of p.contracts)if(!(t.onlyContract&&u.name!==t.onlyContract)){console.log(`Suite: ${p.suite}  Contract: ${u.name}`);for(let c of u.scenarios){if(t.onlyScenario&&c.id!==t.onlyScenario)continue;r++;let s=await R(n,c);if(f.push({suite:p.suite,contract:u.name,...s}),s.ok)console.log(`  \u2705 ${c.id} (${s.status??"?"})`);else {i++,console.log(`  \u274C ${c.id} (${s.status??"?"})`),console.log(`     ${s.method} ${s.url}`);for(let y of s.notes)console.log(`     - ${y}`);if(t.failFast)break}}if(console.log(""),t.failFast&&i>0)break}if(t.failFast&&i>0)break}let d={baseUrl:n,suites:e,total:r,failed:i,passed:r-i,ok:i===0,results:f},g=v__default.default.resolve(process.cwd(),t.report);O__default.default.writeFileSync(g,JSON.stringify(d,null,2),"utf8"),console.log(`Report written: ${g}`),process.exit(i===0?0:1);});S.parse(process.argv);