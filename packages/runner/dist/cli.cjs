#!/usr/bin/env node
"use strict";var T=Object.create;var R=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var F=Object.getPrototypeOf,L=Object.prototype.hasOwnProperty;var P=(t,n,e,i)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of q(n))!L.call(t,r)&&r!==e&&R(t,r,{get:()=>n[r],enumerable:!(i=_(n,r))||i.enumerable});return t};var b=(t,n,e)=>(e=t!=null?T(F(t)):{},P(n||!t||!t.__esModule?R(e,"default",{value:t,enumerable:!0}):e,t));var A=b(require("fs"),1),C=b(require("path"),1),U=b(require("fast-glob"),1),J=require("commander");var O=b(require("fs"),1),N=b(require("path"),1),x=b(require("js-yaml"),1);function H(t){return!!t&&typeof t=="object"&&!Array.isArray(t)}var M=/\$\{([A-Z0-9_]+)\}/g;function l(t){if(typeof t=="string")return t.replace(M,(n,e)=>process.env[e]??"");if(Array.isArray(t))return t.map(l);if(H(t)){let n={};for(let[e,i]of Object.entries(t))n[e]=l(i);return n}return t}function a(t){throw new Error(t)}function h(t){return!!t&&typeof t=="object"&&!Array.isArray(t)}function W(t){let n=O.default.readFileSync(t,"utf8");if(t.endsWith(".yml")||t.endsWith(".yaml"))return x.default.load(n);if(t.endsWith(".json"))return JSON.parse(n);a(`Unsupported file type: ${t}`)}function k(t){let n=N.default.resolve(process.cwd(),t);O.default.existsSync(n)||a(`Suite file not found: ${n}`);let e=W(n);h(e)||a("Suite file must be an object."),e.version!==1&&a(`Unsupported version: ${String(e.version)} (expected 1)`),(typeof e.suite!="string"||!e.suite.trim())&&a("suite must be a string."),(!Array.isArray(e.contracts)||e.contracts.length===0)&&a("contracts must be a non-empty array.");let i=e.contracts.map((r,f)=>{h(r)||a(`contracts[${f}] must be an object.`),(typeof r.name!="string"||!r.name.trim())&&a(`contracts[${f}].name must string.`),(!Array.isArray(r.scenarios)||r.scenarios.length===0)&&a(`contracts[${f}].scenarios must be non-empty array.`);let d=r.scenarios.map((o,p)=>{h(o)||a(`contracts[${f}].scenarios[${p}] must be an object.`),(typeof o.id!="string"||!o.id.trim())&&a("scenario id required."),h(o.http)||a(`Scenario ${o.id}: http must be object.`);let u=String(o.http.method||"").toUpperCase(),c=String(o.http.path||"");u||a(`Scenario ${o.id}: http.method is required.`),c.startsWith("/")||a(`Scenario ${o.id}: http.path must start with "/".`);let s={method:u,path:String(l(c)),headers:h(o.http.headers)?l(o.http.headers):void 0,query:h(o.http.query)?l(o.http.query):void 0,body:l(o.http.body)},y=h(o.expect)?{status:typeof o.expect.status=="number"?o.expect.status:void 0,json:"json"in o.expect?l(o.expect.json):void 0,bodyContains:typeof o.expect.bodyContains=="string"?String(l(o.expect.bodyContains)):void 0}:void 0;return{id:o.id,http:s,expect:y}}),g=new Set;for(let o of d)g.has(o.id)&&a(`Duplicate scenario id in contract "${r.name}": ${o.id}`),g.add(o.id);return{name:r.name,scenarios:d}});return{version:1,suite:e.suite,contracts:i}}function v(t){return!!t&&typeof t=="object"&&!Array.isArray(t)}function w(t,n){if(n===null||typeof n!="object")return Object.is(t,n);if(Array.isArray(n)){if(!Array.isArray(t)||n.length>t.length)return!1;for(let e=0;e<n.length;e++)if(!w(t[e],n[e]))return!1;return!0}if(v(n)){if(!v(t))return!1;for(let e of Object.keys(n))if(!(e in t)||!w(t[e],n[e]))return!1;return!0}return!1}function B(t,n){let e=t.replace(/\/+$/,""),i=n.startsWith("/")?n:`/${n}`;return`${e}${i}`}function Y(t,n){if(!n)return t;let e=new URL(t);for(let[i,r]of Object.entries(n))e.searchParams.set(i,String(r));return e.toString()}async function I(t,n,e){let i=new AbortController,r=setTimeout(()=>i.abort(),e);try{return await fetch(t,{...n,signal:i.signal})}finally{clearTimeout(r)}}async function E(t,n){let e=n.http.method.toUpperCase(),i=Y(B(t,n.http.path),n.http.query),r=[],f={...n.http.headers||{}},d;n.http.body!==void 0&&n.http.body!==null&&(typeof n.http.body=="string"?d=n.http.body:(d=JSON.stringify(n.http.body),f["content-type"]||(f["content-type"]="application/json")));let g=Number(process.env.STONEY_TIMEOUT_MS||15e3),o=Number(process.env.STONEY_RETRIES||2),p;for(let u=0;u<=o;u++)try{let c=await I(i,{method:e,headers:f,body:d},g),s=c.status,y=await c.text(),j;if((c.headers.get("content-type")||"").includes("application/json"))try{j=JSON.parse(y)}catch{r.push("Response advertised JSON but failed to parse JSON.")}let m=n.expect||{},S=!0;return typeof m.status=="number"&&s!==m.status&&(S=!1,r.push(`Expected status ${m.status} but got ${s}.`)),typeof m.bodyContains=="string"&&!y.includes(m.bodyContains)&&(S=!1,r.push(`Expected body to contain: "${m.bodyContains}"`)),m.json!==void 0&&(j===void 0?(S=!1,r.push("Expected JSON subset match, but response was not JSON.")):w(j,m.json)||(S=!1,r.push("Expected JSON subset did not match response JSON."))),{id:n.id,ok:S,method:e,url:i,status:s,notes:r}}catch(c){if(p=c,u<o){let s=500*(u+1);await new Promise(y=>setTimeout(y,s));continue}}return{id:n.id,ok:!1,method:e,url:i,notes:[`Network/timeout error: ${p?.message||String(p)}`]}}var $=new J.Command;$.name("stoney").description("Stoney \u2014 run HTTP contracts in CI.").version("0.0.1");$.command("hello").action(()=>console.log("\u{1FAA8} Stoney is alive."));$.command("parse").argument("<file>","Suite file (.yml/.yaml or .json)").option("--pretty","Pretty-print JSON").action((t,n)=>{let e=k(t);console.log(n.pretty?JSON.stringify(e,null,2):JSON.stringify(e))});$.command("run").requiredOption("--suite <glob>","Suite file path or glob (e.g. contracts/*.yml)").option("--base-url <url>","Base URL (defaults to STONEY_BASE_URL env var)").option("--report <path>","JSON report output path","stoney-report.json").option("--only-contract <name>","Run only one contract by name").option("--only-scenario <id>","Run only one scenario id").option("--fail-fast","Stop on first failure",!1).action(async t=>{let n=t.baseUrl||process.env.STONEY_BASE_URL;n||(console.error("Missing base URL. Provide --base-url or set STONEY_BASE_URL."),process.exit(2));let e=await(0,U.default)(t.suite);e.length||(console.error(`No suite files matched: ${t.suite}`),process.exit(2));let i=0,r=0,f=[];console.log(`
\u{1FAA8} Stoney run`),console.log(`Base URL: ${n}`),console.log(`Suites: ${e.join(", ")}
`);for(let o of e){let p=k(o);for(let u of p.contracts)if(!(t.onlyContract&&u.name!==t.onlyContract)){console.log(`Suite: ${p.suite}  Contract: ${u.name}`);for(let c of u.scenarios){if(t.onlyScenario&&c.id!==t.onlyScenario)continue;r++;let s=await E(n,c);if(f.push({suite:p.suite,contract:u.name,...s}),s.ok)console.log(`  \u2705 ${c.id} (${s.status??"?"})`);else{i++,console.log(`  \u274C ${c.id} (${s.status??"?"})`),console.log(`     ${s.method} ${s.url}`);for(let y of s.notes)console.log(`     - ${y}`);if(t.failFast)break}}if(console.log(""),t.failFast&&i>0)break}if(t.failFast&&i>0)break}let d={baseUrl:n,suites:e,total:r,failed:i,passed:r-i,ok:i===0,results:f},g=C.default.resolve(process.cwd(),t.report);A.default.writeFileSync(g,JSON.stringify(d,null,2),"utf8"),console.log(`Report written: ${g}`),process.exit(i===0?0:1)});$.parse(process.argv);
